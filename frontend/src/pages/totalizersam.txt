// src/pages/TotalizerEntryPage.jsx
import React, { useEffect, useMemo, useState, useCallback, useRef } from "react";
import axios from "axios";

// HeroIcons
import { 
  ChartBarIcon, 
  FireIcon, 
  CloudIcon, 
  BoltIcon, 
  FunnelIcon,
  CalendarDaysIcon,
  ArrowPathIcon,
  CheckCircleIcon,
  TrashIcon,
  BeakerIcon // Added for seed
} from "@heroicons/react/24/solid";

/**
 * TotalizerEntryPage — Professional Sidebar Layout
 * Theme: Corporate Grey / White / Orange
 */

const API_URL = "http://localhost:8080/api";

const normalizeAuthHeader = (auth) => {
  if (!auth) return localStorage.getItem("authToken") || "";
  return auth.startsWith("Bearer ") ? auth : `Bearer ${auth}`;
};

const getTokenPayload = (authHeader) => {
  try {
    const token = authHeader.startsWith("Bearer ") ? authHeader.split(" ")[1] : authHeader;
    const payload = token.split(".")[1];
    return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
  } catch {
    return null;
  }
};

const Spinner = ({ size = 14 }) => (
  <div style={{ width: size, height: size }} className="inline-block animate-spin border-2 border-t-transparent rounded-full border-current" />
);

/* ---------------- KPI dependency map ---------------- */
const KPI_DEPENDENCY_MAP = {
  feeder_a: ["coal_consumption", "specific_coal"],
  feeder_b: ["coal_consumption", "specific_coal"],
  feeder_c: ["coal_consumption", "specific_coal"],
  feeder_d: ["coal_consumption", "specific_coal"],
  feeder_e: ["coal_consumption", "specific_coal"],
  ldo_flow: ["oil_consumption", "specific_oil"],
  dm7: ["dm_water", "specific_dm_percent"],
  dm11: ["dm_water", "specific_dm_percent"],
  main_steam: ["steam_consumption", "specific_steam"],
  raw_water: ["total_raw_water_used_m3", "avg_raw_water_m3_per_hr", "sp_raw_water_l_per_kwh"],
  unit1_gen: ["unit1_generation", "unit1_plf_percent", "station_plf_percent"],
  unit2_gen: ["unit2_generation", "unit2_plf_percent", "station_plf_percent"],
};

export default function TotalizerEntryPage({ auth }) {
  const authHeader = useMemo(() => normalizeAuthHeader(auth), [auth]);

  const api = useMemo(
    () =>
      axios.create({
        baseURL: API_URL,
        headers: { Authorization: authHeader, "Content-Type": "application/json" },
      }),
    [authHeader]
  );

  /* ---------------- state ---------------- */
  const [reportDate, setReportDate] = useState(new Date().toLocaleDateString("en-CA"));
  const [activeTab, setActiveTab] = useState("Unit-1");
  const [message, setMessage] = useState("");
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  const [roleId, setRoleId] = useState(null);
  const [userName, setUserName] = useState("Unknown");
  const isAdmin = roleId === 8;
  const isHOD = roleId === 7;
  const canAdjust = isAdmin || isHOD;

  const [permissionMap, setPermissionMap] = useState({});
  const canView = (field) => permissionMap[field]?.can_view ?? true;
  const canEdit = (field) => permissionMap[field]?.can_edit ?? true;

  const [totalizersByUnit, setTotalizersByUnit] = useState({
    "Unit-1": [],
    "Unit-2": [],
    Station: [],
    "Energy-Meter": [],
  });

  const [readingsForm, setReadingsForm] = useState({}); 
  const [lastUpdatedInfo, setLastUpdatedInfo] = useState(null);

  const [serverKPIs, setServerKPIs] = useState({ "Unit-1": null, "Unit-2": null, Station: null });
  const [energyCache, setEnergyCache] = useState({});
  const [shutdownKPIs, setShutdownKPIs] = useState({
    "Unit-1": { running_hour: null, plant_availability_percent: null, planned_outage_hour: null, planned_outage_percent: null, strategic_outage_hour: null },
    "Unit-2": { running_hour: null, plant_availability_percent: null, planned_outage_hour: null, planned_outage_percent: null, strategic_outage_hour: null },
  });

  const [highlightedKPIs, setHighlightedKPIs] = useState({});

  // Confirmation / preview state
  const [showConfirmPopup, setShowConfirmPopup] = useState(false);
  const [confirmList, setConfirmList] = useState([]);
  const [previewAutoKPIs, setPreviewAutoKPIs] = useState(null);
  const [previewLoading, setPreviewLoading] = useState(false);

  // Adjust popup
  const [showAdjustPopup, setShowAdjustPopup] = useState(false);
  const [adjustPopupRecord, setAdjustPopupRecord] = useState(null);

  // Manual KPI state and metadata
  const initialManualKPI = {
    "Unit-1": { stack_emission: "" },
    "Unit-2": { stack_emission: "" },
    Station: {
      clarifier_level: "",
      ro_running_hour: "",
      ro_production_cum: "",
      stn_net_export_exbus: "",
      coal_indonesian_percent: "",
      coal_southafrica_percent: "",
      coal_domestic_percent: "",
    },
    "Energy-Meter": {},
  };
  const [manualKPI, setManualKPI] = useState(JSON.parse(JSON.stringify(initialManualKPI)));
  const manualUnits = {
    "Unit-1": { stack_emission: "mg/Nm3" },
    "Unit-2": { stack_emission: "mg/Nm3" },
    Station: {
      clarifier_level: "%",
      ro_running_hour: "hr",
      ro_production_cum: "m3",
      stn_net_export_exbus: "MWh",
      coal_indonesian_percent: "%",
      coal_southafrica_percent: "%",
      coal_domestic_percent: "%",
    },
    "Energy-Meter": {},
  };

  const mountedRef = useRef(true);
  useEffect(() => () => (mountedRef.current = false), []);

  /* ---------------- auth & permissions ---------------- */
  useEffect(() => {
    const payload = getTokenPayload(authHeader);
    if (payload) {
      setRoleId(payload.role_id);
      setUserName(payload.full_name || payload.sub || "User");
    } else {
      api.get("/auth/me").then((r) => {
        if (r.data?.role_id) setRoleId(r.data.role_id);
        if (r.data?.full_name) setUserName(r.data.full_name);
      }).catch(() => {});
    }
  }, [api, authHeader]);

  useEffect(() => {
    async function loadPerm() {
      try {
        const r = await api.get("/permissions/me");
        const pmap = {};
        (r.data || []).forEach((p) => {
          pmap[p.field_name] = { can_edit: !!p.can_edit, can_view: !!p.can_view };
        });
        setPermissionMap(pmap);
      } catch (e) { }
    }
    loadPerm();
  }, [api]);

  /* ---------------- master + readings load ---------------- */
  const loadMasterForUnit = useCallback(async (unit) => {
    try {
      const r = await api.get(`/totalizers/${encodeURIComponent(unit)}/master`);
      const items = r.data || [];
      setTotalizersByUnit((prev) => ({ ...prev, [unit]: items }));

      setReadingsForm((prev) => {
        const updated = { ...prev };
        items.forEach((t) => {
          if (!updated[t.id]) {
            updated[t.id] = {
              today: "",
              adjust: 0,
              yesterday: "—",
              difference: "—",
              display_name: t.display_name,
              name: t.name,
              unit: t.unit || unit,
              totalizer_id: t.id,
              _orig: { today: "", adjust: 0 },
            };
          } else {
            updated[t.id].display_name = t.display_name;
            updated[t.id].name = t.name;
            updated[t.id].unit = t.unit || unit;
          }
        });
        return updated;
      });

      await loadTodayReadings(reportDate, unit, items);
      await loadYesterdayReadings(reportDate, unit, items);
    } catch (e) {
      console.error("loadMasterForUnit error:", e);
    }
  }, [api, reportDate]);

  useEffect(() => {
    loadMasterForUnit("Unit-1");
    loadMasterForUnit("Unit-2");
    loadMasterForUnit("Station");
    loadMasterForUnit("Energy-Meter");
  }, []);

  const loadTodayReadings = useCallback(async (forDate, unit, itemsParam = null) => {
    try {
      const res = await api.get(`/totalizers/${encodeURIComponent(unit)}/readings`, { params: { date: forDate } });
      const rows = res.data || [];
      const rowMap = {};
      let lastUpdate = null;
      rows.forEach((r) => {
        rowMap[r.totalizer_id] = { today: Number(r.reading_value || 0), adjust: Number(r.adjust_value || 0) };
        if (!lastUpdate && r.updated_at) lastUpdate = { at: r.updated_at, by: r.username || "Unknown" };
      });
      setLastUpdatedInfo(lastUpdate);

      setReadingsForm((prev) => {
        const updated = { ...prev };
        const items = itemsParam || (totalizersByUnit[unit] || []);
        items.forEach((t) => {
          const rec = updated[t.id] || {
            today: "", adjust: 0, yesterday: "—", difference: "—", display_name: t.display_name, name: t.name, unit: t.unit || unit, totalizer_id: t.id, _orig: { today: "", adjust: 0 }
          };
          if (rowMap[t.id] !== undefined) {
            rec.today = rowMap[t.id].today;
            rec.adjust = rowMap[t.id].adjust;
            rec._orig = { today: rec.today, adjust: rec.adjust };
          } else {
            rec.today = "";
            rec.adjust = rec._orig?.adjust ?? 0;
          }
          if (rec.yesterday === "—" || rec.today === "" || rec.today === null) rec.difference = "—";
          updated[t.id] = { ...rec };
        });
        return updated;
      });
    } catch (e) {
      console.error("loadTodayReadings error:", e);
    }
  }, [api, totalizersByUnit]);

  const loadYesterdayReadings = useCallback(async (forDate, unit, itemsParam = null) => {
    try {
      const d = new Date(forDate);
      d.setDate(d.getDate() - 1);
      const y = d.toLocaleDateString("en-CA");
      const res = await api.get(`/totalizers/${encodeURIComponent(unit)}/readings`, { params: { date: y } });
      const rows = res.data || [];
      const rowMap = {};
      rows.forEach((r) => { rowMap[r.totalizer_id] = Number(r.reading_value || 0); });

      setReadingsForm((prev) => {
        const updated = { ...prev };
        const items = itemsParam || (totalizersByUnit[unit] || []);
        items.forEach((t) => {
          const rec = updated[t.id];
          if (!rec) return;
          rec.yesterday = rowMap[t.id] !== undefined ? rowMap[t.id] : "—";
          if (rec.yesterday === "—" || rec.today === "" || rec.today === null) rec.difference = "—";
          else {
            const adj = canAdjust ? Number(rec.adjust || 0) : 0;
            rec.difference = Number(rec.today - rec.yesterday + adj).toFixed(3);
          }
          updated[t.id] = { ...rec };
        });
        return updated;
      });
    } catch (e) {
      setReadingsForm((prev) => {
        const updated = { ...prev };
        const items = itemsParam || (totalizersByUnit[unit] || []);
        items.forEach((t) => {
          if (!updated[t.id]) return;
          updated[t.id].yesterday = "—";
          updated[t.id].difference = "—";
        });
        return updated;
      });
    }
  }, [api, totalizersByUnit, canAdjust]);

  /* ---------------- energy cache loader ---------------- */
  const loadEnergyCacheForDate = useCallback(async (dateStr) => {
    if (energyCache[dateStr]) return energyCache[dateStr];
    try {
      const r = await api.get("/kpi/energy", { params: { date: dateStr } });
      let out = {};
      if (Array.isArray(r.data?.kpis)) {
        r.data.kpis.forEach(k => { out[k.name] = Number(k.value || 0); });
      } else if (typeof r.data === "object" && r.data !== null) {
        out = Object.fromEntries(Object.entries(r.data).map(([k, v]) => [k, Number(v || 0)]));
      }
      setEnergyCache((prev) => ({ ...prev, [dateStr]: out }));
      return out;
    } catch (e) {
      setEnergyCache((prev) => ({ ...prev, [dateStr]: {} }));
      return {};
    }
  }, [api, energyCache]);

  /* ---------------- build readings payload ---------------- */
  const buildReadingsArrayForUnit = useCallback((unit) => {
    const items = totalizersByUnit[unit] || [];
    return items.map((t) => {
      const rec = readingsForm[t.id] || { today: "", adjust: 0 };
      return {
        totalizer_id: t.id,
        reading_value: rec.today === "" ? null : Number(rec.today),
        adjust_value: canAdjust ? Number(rec.adjust || 0) : 0,
      };
    }).filter(Boolean);
  }, [readingsForm, totalizersByUnit, canAdjust]);

  /* ---------------- KPI Calculation (on demand) ---------------- */
  const calculateKPIsForUnit = useCallback(async (unit = null) => {
    const plant = unit || activeTab;
    setLoading(true);
    setMessage("");
    try {
      await loadEnergyCacheForDate(reportDate);
      const readings = buildReadingsArrayForUnit(plant);
      const payload = { date: reportDate, plant_name: plant, readings };
      const r = await api.post("/kpi/calc", payload);
      const out = r.data?.auto_kpis || null;
      if (plant === "Unit-1" || plant === "Unit-2" || plant === "Station") {
        setServerKPIs((prev) => ({ ...prev, [plant]: out }));
      }
      setMessage("✅ KPI calculation completed.");
      return out;
    } catch (e) {
      console.error("calculateKPIsForUnit error:", e);
      setMessage("❌ KPI calculation failed.");
      return null;
    } finally {
      setLoading(false);
    }
  }, [api, activeTab, reportDate, buildReadingsArrayForUnit, loadEnergyCacheForDate]);

  /* ---------------- Shutdown KPI loader ---------------- */
  const loadShutdownKPIsForUnitDate = useCallback(async (unitKey, dateStr) => {
    try {
      const res = await api.get(`/kpi/shutdown/${encodeURIComponent(unitKey)}`, { params: { date: dateStr } });
      if (res.status === 200 && res.data) {
        setShutdownKPIs((prev) => ({ ...prev, [unitKey]: { ...prev[unitKey], ...res.data } }));
      } else {
        setShutdownKPIs((prev) => ({ ...prev, [unitKey]: { running_hour: 24, plant_availability_percent: 100, planned_outage_hour: 0, planned_outage_percent: 0, strategic_outage_hour: 0 } }));
      }
    } catch {
      setShutdownKPIs((prev) => ({ ...prev, [unitKey]: { running_hour: 24, plant_availability_percent: 100, planned_outage_hour: 0, planned_outage_percent: 0, strategic_outage_hour: 0 } }));
    }
  }, [api]);

  /* ---------------- helpers to update fields ----------------- */
  const updateField = (id, field, value) => {
    setReadingsForm((prev) => {
      const rec = { ...prev[id] };
      const name = rec.name;
      rec[field] = value === "" ? "" : Number(value);

      if (rec.yesterday === "—" || rec.today === "" || rec.today === null) rec.difference = "—";
      else {
        const adj = canAdjust ? Number(rec.adjust || 0) : 0;
        rec.difference = Number(rec.today - rec.yesterday + adj).toFixed(3);
      }

      const impacted = KPI_DEPENDENCY_MAP[name] || [];
      if (impacted.length > 0) {
        const newState = {};
        impacted.forEach(k => newState[k] = true);
        setHighlightedKPIs(newState);
        setTimeout(() => setHighlightedKPIs({}), 1400);
      }

      return { ...prev, [id]: rec };
    });
  };

  const updateManualField = (unit, field, value) => {
    setManualKPI((prev) => ({
      ...prev,
      [unit]: { ...prev[unit], [field]: value === "" ? "" : Number(value) },
    }));
  };

  const getDiff = (name, unitFilter = null) => {
    const unitToUse = unitFilter || activeTab;
    const rec = Object.values(readingsForm).find((r) => r.name === name && (r.unit || "").toString() === unitToUse);
    if (!rec) return 0;
    if (!rec.difference || rec.difference === "—") return 0;
    return Number(rec.difference) || 0;
  };

  /* ---------------- Local KPI computations ---------------- */
  const localUnitKPI = useMemo(() => {
    if (!(activeTab === "Unit-1" || activeTab === "Unit-2")) return null;
    try {
      const feederA = getDiff("feeder_a", activeTab);
      const feederB = getDiff("feeder_b", activeTab);
      const feederC = getDiff("feeder_c", activeTab);
      const feederD = getDiff("feeder_d", activeTab);
      const feederE = getDiff("feeder_e", activeTab);
      const coal = feederA + feederB + feederC + feederD + feederE;
      const ldo = getDiff("ldo_flow", activeTab);
      const dm = getDiff("dm7", activeTab) + getDiff("dm11", activeTab);
      const steam = getDiff("main_steam", activeTab);
      return { coal, ldo, dm, steam };
    } catch {
      return { coal: 0, ldo: 0, dm: 0, steam: 0 };
    }
  }, [readingsForm, activeTab]);

  const localStationKPI = useMemo(() => {
    if (activeTab !== "Station") return null;
    try {
      const total_raw_water = getDiff("raw_water", "Station");
      const avg_raw_per_hr = Number((total_raw_water / 24.0).toFixed(3));
      const u1_dm = getDiff("dm7", "Unit-1") + getDiff("dm11", "Unit-1");
      const u2_dm = getDiff("dm7", "Unit-2") + getDiff("dm11", "Unit-2");
      const total_dm = Number((u1_dm + u2_dm).toFixed(3));
      return { total_raw_water, avg_raw_per_hr, total_dm };
    } catch {
      return { total_raw_water: 0, avg_raw_per_hr: 0, total_dm: 0 };
    }
  }, [readingsForm, activeTab]);

  const liveEnergyKPI = useMemo(() => {
    const d = (k) => getDiff(k, "Energy-Meter");
    try {
      const unit1_unit_aux_mwh = d("1lsr01_ic1") + d("1lsr02_ic1");
      const unit2_unit_aux_mwh = d("2lsr01_ic1") + d("2lsr02_ic1");
      const total_station_aux_mwh = d("rlsr01") + d("rlsr02") + d("rlsr03") + d("rlsr04") + d("SST_10") + d("UST_15") + d("UST_25");
      const total_station_tie_mwh = d("1lsr01_ic2_tie") + d("1lsr02_ic2_tie") + d("2lsr01_ic2_tie") + d("2lsr02_ic2_tie");
      const unit1_gen = d("unit1_gen");
      const unit2_gen = d("unit2_gen");
      const unit1_aux_consumption_mwh = unit1_unit_aux_mwh + (total_station_aux_mwh + total_station_tie_mwh) / 2.0;
      const unit2_aux_consumption_mwh = unit2_unit_aux_mwh + (total_station_aux_mwh + total_station_tie_mwh) / 2.0;
      const unit1_aux_percent = unit1_gen > 0 ? (unit1_aux_consumption_mwh / unit1_gen) * 100.0 : 0.0;
      const unit2_aux_percent = unit2_gen > 0 ? (unit2_aux_consumption_mwh / unit2_gen) * 100.0 : 0.0;
      const unit1_plf_percent = unit1_gen > 0 ? (unit1_gen / 3000.0) * 100.0 : 0.0;
      const unit2_plf_percent = unit2_gen > 0 ? (unit2_gen / 3000.0) * 100.0 : 0.0;
      const station_plf_percent = (unit1_gen + unit2_gen) > 0 ? ((unit1_gen + unit2_gen) / 3000.0) * 100.0 : 0.0;

      return {
        unit1_generation: Number(unit1_gen.toFixed(3)),
        unit2_generation: Number(unit2_gen.toFixed(3)),
        unit1_unit_aux_mwh: Number(unit1_unit_aux_mwh.toFixed(3)),
        unit2_unit_aux_mwh: Number(unit2_unit_aux_mwh.toFixed(3)),
        total_station_aux_mwh: Number(total_station_aux_mwh.toFixed(3)),
        total_station_tie_mwh: Number(total_station_tie_mwh.toFixed(3)),
        unit1_aux_consumption_mwh: Number(unit1_aux_consumption_mwh.toFixed(3)),
        unit1_aux_percent: Number(unit1_aux_percent.toFixed(3)),
        unit2_aux_consumption_mwh: Number(unit2_aux_consumption_mwh.toFixed(3)),
        unit2_aux_percent: Number(unit2_aux_percent.toFixed(3)),
        unit1_plf_percent: Number(unit1_plf_percent.toFixed(3)),
        unit2_plf_percent: Number(unit2_plf_percent.toFixed(3)),
        station_plf_percent: Number(station_plf_percent.toFixed(3)),
      };
    } catch {
      return {};
    }
  }, [readingsForm]);

  /* ---------------- Submit flow ---------------- */
  const getChangedList = (unit) => {
    const list = [];
    const items = totalizersByUnit[unit] || [];
    items.forEach((t) => {
      const rec = readingsForm[t.id];
      if (!rec) return;
      const orig = rec._orig || { today: "", adjust: 0 };
      if (String(rec.today) !== String(orig.today) && rec.today !== "") {
        list.push({ label: rec.display_name, value: rec.today, old: orig.today ?? "", id: t.id });
      } else if (canAdjust && String(rec.adjust) !== String(orig.adjust)) {
        list.push({ label: rec.display_name + " (Adj)", value: rec.adjust, old: orig.adjust ?? 0, id: t.id });
      }
    });
    return list;
  };

  const handleSubmitClick = () => {
    const changed = getChangedList(activeTab);
    if (changed.length === 0 && !hasManualKPIChange()) {
      setMessage("❌ No changes.");
      return;
    }

    if (!isAdmin && !isHOD) {
      for (const ch of changed) {
        const rec = readingsForm[ch.id];
        if (rec._orig.today !== "") {
          setMessage(`❌ Only Admin/HOD can modify existing values (${ch.label})`);
          return;
        }
      }
    }

    setConfirmList(changed);
    setPreviewAutoKPIs(null); 
    setShowConfirmPopup(true);
  };

  const hasManualKPIChange = () => {
    const currentManuals = manualKPI[activeTab] || {};
    return Object.values(currentManuals).some((v) => v !== "" && v !== null && v !== undefined);
  };

  const confirmSubmit = async () => {
    setShowConfirmPopup(false);
    setSubmitting(true);
    setMessage("");

    try {
      const items = totalizersByUnit[activeTab] || [];
      const payload = {
        date: reportDate,
        username: userName,
        plant_name: activeTab,
        readings: items
          .map((t) => {
            const rec = readingsForm[t.id];
            if (!rec || rec.today === "" || rec.today === null) return null;
            return {
              totalizer_id: t.id,
              reading_value: Number(rec.today),
              adjust_value: canAdjust ? Number(rec.adjust || 0) : 0,
            };
          })
          .filter(Boolean),
        manual_kpis: Object.entries(manualKPI[activeTab] || {}).map(([name, val]) => ({
          name,
          value: val === "" || val === null || val === undefined ? null : Number(val),
          unit: manualUnits[activeTab]?.[name] || null,
        })).filter(m => m.value !== null),
      };

      await api.post("/totalizers/submit", payload);

      setReadingsForm((prev) => {
        const updated = { ...prev };
        items.forEach((t) => {
          const rec = updated[t.id];
          if (rec) rec._orig = { today: rec.today, adjust: rec.adjust };
        });
        return updated;
      });

      setLastUpdatedInfo({ at: new Date().toISOString(), by: userName });
      setMessage("✅ Readings saved");

      await loadYesterdayReadings(reportDate, activeTab, totalizersByUnit[activeTab]);
      await loadManualKPIForActiveTab();
      if (activeTab === "Unit-1" || activeTab === "Unit-2") {
        await loadShutdownKPIsForUnitDate(activeTab, reportDate);
      }
      await calculateKPIsForUnit(activeTab);
    } catch (err) {
      console.error(err);
      setMessage(`❌ ${err?.response?.data?.detail || "Save error"}`);
    } finally {
      setSubmitting(false);
    }
  };

  /* ---------------- Reset / Seed ---------------- */
  const handleResetForm = () => {
    const items = totalizersByUnit[activeTab] || [];
    setReadingsForm((prev) => {
      const updated = { ...prev };
      items.forEach((t) => {
        if (!updated[t.id]) return;
        updated[t.id].today = updated[t.id]._orig?.today ?? "";
        updated[t.id].adjust = updated[t.id]._orig?.adjust ?? 0;
        if (updated[t.id].yesterday === "—" || updated[t.id].today === "" || updated[t.id].today === null) updated[t.id].difference = "—";
        else {
          const adj = canAdjust ? Number(updated[t.id].adjust || 0) : 0;
          updated[t.id].difference = Number(updated[t.id].today - updated[t.id].yesterday + adj).toFixed(3);
        }
      });
      return updated;
    });

    setManualKPI((prev) => ({ ...prev, [activeTab]: { ...(initialManualKPI[activeTab] || {}), ...(prev[activeTab] || {}) } }));
    setMessage("⚠️ Inputs reset.");
  };

  const handleSeedMaster = async () => {
    setMessage("Loading previous day's closing readings...");
    setLoading(true);
    try {
      const d = new Date(reportDate);
      d.setDate(d.getDate() - 1);
      const y = d.toLocaleDateString("en-CA");
      const res = await api.get(`/totalizers/${encodeURIComponent(activeTab)}/readings`, { params: { date: y } });
      const rows = res.data || [];
      const rowMap = {};
      rows.forEach((r) => { rowMap[r.totalizer_id] = Number(r.reading_value || 0); });

      setReadingsForm((prev) => {
        const updated = { ...prev };
        (totalizersByUnit[activeTab] || []).forEach((t) => {
          const rec = updated[t.id];
          if (!rec) return;
          const prevValue = rowMap[t.id];
          if (prevValue !== undefined && rec._orig.today === "") {
            updated[t.id].today = prevValue;
            updated[t.id].adjust = rec._orig.adjust ?? 0;
            const adj = canAdjust ? Number(updated[t.id].adjust || 0) : 0;
            updated[t.id].difference = Number(updated[t.id].today - (rec.yesterday === "—" ? 0 : rec.yesterday) + adj).toFixed(3);
          }
        });
        return updated;
      });

      setMessage("ℹ️ Readings seeded from previous day.");
    } catch (e) {
      console.error(e);
      setMessage("❌ Failed to seed readings.");
    } finally {
      setLoading(false);
    }
  };

  /* ---------------- Adjust popup ---------------- */
  const handleAdjustClick = (record) => {
    setAdjustPopupRecord(record);
    setShowAdjustPopup(true);
  };

  const saveAdjust = () => {
    if (!adjustPopupRecord) return;
    const { id, adjust } = adjustPopupRecord;
    updateField(id, "adjust", adjust);
    setShowAdjustPopup(false);
    setAdjustPopupRecord(null);
  };

  /* ---------------- Manual KPI loader ---------------- */
  const loadManualKPIForActiveTab = useCallback(async () => {
    try {
      const r = await api.get("/kpi/manual", { params: { date: reportDate, unit: activeTab } });
      const fetched = {};
      (r.data?.kpis || []).forEach((k) => {
        if (k.kpi_name) fetched[k.kpi_name] = k.kpi_value;
        else if (k.kpi) fetched[k.kpi] = k.value;
      });

      setManualKPI((prev) => ({
        ...prev,
        [activeTab]: {
          ...(initialManualKPI[activeTab] || {}),
          ...fetched
        }
      }));
    } catch (err) {
      console.error("Manual KPI load failed", err);
      setManualKPI((prev) => ({ ...prev, [activeTab]: { ...(initialManualKPI[activeTab] || {}) } }));
    }
  }, [api, activeTab, reportDate]);

  /* ---------------- KPI panel helpers & rendering ---------------- */
  const renderKpiValue = (k) => {
    if ((activeTab === "Unit-1" || activeTab === "Unit-2") && localUnitKPI) {
      const map = {
        coal_consumption: localUnitKPI.coal,
        oil_consumption: localUnitKPI.ldo,
        dm_water: localUnitKPI.dm,
        steam_consumption: localUnitKPI.steam,
      };
      if (map[k] !== undefined) return map[k];
    }
    if (activeTab === "Station" && localStationKPI) {
      const map = {
        total_raw_water_used_m3: localStationKPI.total_raw_water,
        avg_raw_water_m3_per_hr: localStationKPI.avg_raw_per_hr,
        total_dm_water_used_m3: localStationKPI.total_dm,
      };
      if (map[k] !== undefined) return map[k];
    }
    const s = serverKPIs[activeTab] || {};
    if (s && s[k] !== undefined && s[k] !== null) return s[k];
    if (activeTab === "Energy-Meter") {
      const ek = liveEnergyKPI || {};
      if (ek[k] !== undefined) return ek[k];
    }
    return null;
  };

  const KpiCard = ({ k, label, value, unit = "", Icon = ChartBarIcon }) => {
    const isHighlighted = !!highlightedKPIs[k];
    return (
      <div className={`flex items-center justify-between p-1 rounded-lg transition-all duration-200 border ${isHighlighted ? "border-orange-400 bg-orange-50 shadow-[0_6px_18px_rgba(249,115,22,0.08)] scale-[1.02]" : "border-gray-200 bg-white"} `}>
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-md bg-gray-100 text-orange-600">
            <Icon className="w-5 h-5" />
          </div>
          <div className="text-xs text-gray-600">{label}</div>
        </div>
        <div className="text-right ml-3">
          <div className="font-bold text-sm text-gray-900">
            {value === null || value === undefined ? "—" : (typeof value === "number" ? (unit === "%" ? value.toFixed(2) : value.toFixed(3)) : value)}
          </div>
          <div className="text-xs text-orange-600">{unit}</div>
        </div>
      </div>
    );
  };

 const renderLeftKPIList = () => {
    if (activeTab === "Unit-1" || activeTab === "Unit-2") {
      const s = serverKPIs[activeTab] || {};
      const local = localUnitKPI || { coal: 0, ldo: 0, dm: 0, steam: 0 };
      const sKPI = shutdownKPIs[activeTab] || {};
      return (
        <div className="space-y-3">
          <div className="text-xs font-semibold text-gray-700">Unit Performance</div>
          <KpiCard k="daily_generation" label="Daily Generation" value={(activeTab === "Unit-1" ? (s?.unit1_generation ?? null) : (s?.unit2_generation ?? null)) ?? null} unit="MWh" Icon={ChartBarIcon} />
          <KpiCard k="plf" label="PLF" value={(activeTab === "Unit-1" ? s?.unit1_plf_percent : s?.unit2_plf_percent) ?? null} unit="%" Icon={ChartBarIcon} />
          <KpiCard k="running_hour" label="Running Hour" value={sKPI.running_hour !== null ? Number(sKPI.running_hour) : null} unit="hr" Icon={BoltIcon} />

          <div className="text-xs font-semibold text-gray-700 mt-3">Fuel & Utilities</div>
          <KpiCard k="coal_consumption" label="Coal Cons." value={renderKpiValue("coal_consumption") ?? local.coal} unit="ton" Icon={FireIcon} />
          <KpiCard k="specific_coal" label="Specific Coal" value={renderKpiValue("specific_coal") ?? null} unit="ton/MWh" Icon={ChartBarIcon} />
          <KpiCard k="oil_consumption" label="LDO Cons." value={renderKpiValue("oil_consumption") ?? local.ldo} unit="L" Icon={FunnelIcon} />
          <KpiCard k="specific_oil" label="LDO Cons." value={renderKpiValue("specific_oil") ?? local.ldo} unit="L" Icon={FunnelIcon} />
          <KpiCard k="dm_water" label="DM Water" value={renderKpiValue("dm_water") ?? local.dm} unit="m3" Icon={CloudIcon} />
          <KpiCard k="steam_consumption" label="Steam Cons." value={renderKpiValue("steam_consumption") ?? local.steam} unit="kg" Icon={BoltIcon} />
        </div>
      );
    }

    if (activeTab === "Station") {
      const s = serverKPIs["Station"] || {};
      const local = localStationKPI || { total_raw_water: 0, avg_raw_per_hr: 0, total_dm: 0 };
      return (
        <div className="space-y-3">
          <div className="text-xs font-semibold text-gray-700">Station KPIs</div>
          <KpiCard k="station_plf_percent" label="Station PLF" value={s?.station_plf_percent ?? (((Number(s?.unit1_generation || 0) + Number(s?.unit2_generation || 0)) > 0) ? (((Number(s.unit1_generation || 0) + Number(s.unit2_generation || 0)) / 3000) * 100) : null)} unit="%" Icon={ChartBarIcon} />
          <KpiCard k="total_raw_water_used_m3" label="Total Raw Water" value={renderKpiValue("total_raw_water_used_m3") ?? local.total_raw_water} unit="m3" Icon={CloudIcon} />
          <KpiCard k="avg_raw_water_m3_per_hr" label="Avg Raw Water/hr" value={renderKpiValue("avg_raw_water_m3_per_hr") ?? local.avg_raw_per_hr} unit="m3/hr" Icon={CloudIcon} />
          <KpiCard k="total_dm_water_used_m3" label="Total DM Water" value={renderKpiValue("total_dm_water_used_m3") ?? local.total_dm} unit="m3" Icon={CloudIcon} />
        </div>
      );
    }

    if (activeTab === "Energy-Meter") {
      const ek = liveEnergyKPI || {};
      return (
        <div className="space-y-3">
          <div className="text-xs font-semibold text-gray-700">Energy (live)</div>
          <KpiCard k="unit1_generation" label="U1 Gen" value={ek.unit1_generation ?? 0} unit="MWh" Icon={ChartBarIcon} />
          <KpiCard k="unit2_generation" label="U2 Gen" value={ek.unit2_generation ?? 0} unit="MWh" Icon={ChartBarIcon} />
          <KpiCard k="unit1_aux_percent" label="U1 Aux %" value={ek.unit1_aux_percent ?? 0} unit="%" Icon={BoltIcon} />
          <KpiCard k="unit2_aux_percent" label="U2 Aux %" value={ek.unit2_aux_percent ?? 0} unit="%" Icon={BoltIcon} />
          <KpiCard k="station_plf_percent" label="Station PLF" value={ek.station_plf_percent ?? 0} unit="%" Icon={ChartBarIcon} />
        </div>
      );
    }

    return null;
  };

  /* ---------------- Table render ---------------- */
  const currentTotalizers = totalizersByUnit[activeTab] || [];

  const renderTotalizerTable = () => (
    <div className="max-h-[65vh] overflow-auto bg-white border border-zinc-300 shadow-sm">
      <table className="min-w-full table-fixed border-collapse">
        <thead className="sticky top-0 z-20">
          <tr className="bg-zinc-100 text-zinc-700 text-[11px] uppercase tracking-wider font-bold">
            <th className="px-3 py-2 text-left w-[240px] border-r border-zinc-200 align-middle">Totalizer</th>
            <th className="px-2 py-2 text-right w-[110px] border-r border-zinc-200 align-middle">Today</th>
            <th className="px-2 py-2 text-right w-[110px] border-r border-zinc-200 align-middle">Yesterday</th>
            <th className="px-2 py-2 text-right w-[90px] align-middle">Diff</th>
          </tr>
          <tr className="h-[2px] bg-orange-400 w-full absolute left-0 right-0 bottom-0 z-30 block"></tr>
        </thead>
        <tbody className="text-[12px] bg-white">
          {currentTotalizers.filter(t => canView(t.name)).map((t) => {
            const rec = readingsForm[t.id];
            if (!rec) return null;
            const isEditable = canEdit(t.name);
            const adjustVal = Number(rec.adjust);
            const hasAdjustment = !isNaN(adjustVal) && adjustVal !== 0;

            return (
              <tr key={t.id} className="group hover:bg-orange-50 transition-colors duration-150 border-b border-zinc-100">
                <td className="px-3 py-1 text-zinc-800 font-medium truncate align-middle border-r border-zinc-100">
                  {t.display_name}
                </td>
                <td className="px-1 py-1 text-right align-middle border-r border-zinc-100 bg-zinc-50/30">
                  <input
                    type="number"
                    step="1"
                    value={rec.today === "" ? "" : rec.today}
                    onChange={(e) => updateField(t.id, "today", e.target.value)}
                    onDoubleClick={() => canAdjust && handleAdjustClick({ id: t.id, adjust: rec.adjust || 0 })}
                    readOnly={!isEditable}
                    placeholder="0.00"
                    className={`w-full h-7 px-2 font-mono text-[13px] text-right font-semibold outline-none transition-all duration-150 rounded-none
                      ${isEditable ? "bg-zinc-50 text-zinc-900 border border-zinc-300 shadow-[inset_0_1px_2px_rgba(0,0,0,0.06)] focus:bg-white focus:shadow-none focus:border-orange-400 focus:ring-1 focus:ring-orange-400" 
                      : "bg-zinc-100 text-zinc-400 cursor-not-allowed border-none shadow-none"}`}
                  />
                </td>
                <td className="px-2 py-1 text-right font-mono text-[12px] text-zinc-500 whitespace-nowrap align-middle border-r border-zinc-100">
                  {rec.yesterday}
                </td>
                <td className="px-2 py-1 text-right align-middle">
                  <div className="flex items-center justify-end gap-1">
                    <span className={`font-bold font-mono text-[13px] ${Number(rec.difference) < 0 ? 'text-red-600' : 'text-zinc-700'}`}>
                      {rec.difference}
                    </span>
                    {hasAdjustment && (
                      <span className="flex items-center justify-center w-3 h-3 bg-orange-100 text-orange-600 text-[9px] font-bold rounded-none cursor-help" title={`Adjustment: ${adjustVal}`}>*</span>
                    )}
                  </div>
                </td>
              </tr>
            );
          })}
        </tbody>
        <tfoot>
          <tr className="bg-zinc-50 border-t border-zinc-300">
            <td colSpan="4" className="px-3 py-1 text-right text-[10px] text-zinc-500">
              {lastUpdatedInfo ? (
                <>Updated: <strong>{new Date(lastUpdatedInfo.at).toLocaleString()}</strong> by <span className="text-orange-500 font-bold uppercase">{lastUpdatedInfo.by}</span></>
              ) : <span>No data</span>}
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  );

  /* ---------------- confirm & adjust popups ---------------- */
  const previewChangedKPIs = async () => {
    setPreviewLoading(true);
    try {
      const readings = buildReadingsArrayForUnit(activeTab);
      const payload = { date: reportDate, plant_name: activeTab, readings };
      const r = await api.post("/kpi/calc", payload);
      setPreviewAutoKPIs(r.data?.auto_kpis || null);
    } catch (err) {
      console.error("previewChangedKPIs error", err);
      setPreviewAutoKPIs(null);
    } finally {
      setPreviewLoading(false);
    }
  };

  const renderConfirmPopup = () => {
    if (!showConfirmPopup) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div className="bg-white rounded-lg shadow-lg w-full max-w-2xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-semibold text-orange-600">Confirm changed inputs</h3>
            <button onClick={() => setShowConfirmPopup(false)} className="text-sm text-gray-500">Close</button>
          </div>
          <div className="max-h-64 overflow-auto border rounded p-2 bg-gray-50">
            <div className="text-sm text-gray-700 mb-2">Date: <strong>{reportDate}</strong> — <strong>{activeTab}</strong></div>
            <div className="mb-2">
              <div className="font-medium text-gray-800 text-sm mb-1">Changed Totalizer Readings</div>
              {confirmList.length > 0 ? (
                <ul className="text-sm text-gray-600 list-disc ml-5 space-y-1">
                  {confirmList.map((c, i) => (
                    <li key={i}>
                      <strong>{c.label}</strong>: <span className="text-gray-500">{String(c.old)}</span> → <span className="text-orange-600 font-semibold">{String(c.value)}</span>
                    </li>
                  ))}
                </ul>
              ) : <div className="text-sm text-gray-500 italic">No totalizer changes</div>}
            </div>
            <div className="mt-3">
              <div className="flex items-center justify-between">
                <div className="font-medium text-gray-800 text-sm">Preview Auto KPIs</div>
                <button onClick={previewChangedKPIs} disabled={previewLoading} className="text-xs px-2 py-1 rounded bg-orange-50 border text-orange-700">
                  {previewLoading ? <Spinner size={12} /> : "Preview"}
                </button>
              </div>
              <div className="mt-2">
                {previewAutoKPIs ? (
                  <div className="grid grid-cols-2 gap-2">
                    {Object.entries(previewAutoKPIs).map(([k, v]) => (
                      <div key={k} className="p-2 border rounded bg-white text-sm">
                        <div className="text-xs text-gray-500">{k.replace(/_/g, " ")}</div>
                        <div className="font-bold text-gray-900">{typeof v === "number" ? (String(Number(v.toFixed(3)))) : String(v)}</div>
                      </div>
                    ))}
                  </div>
                ) : <div className="text-xs text-gray-400 italic">No preview. Click Preview to compute auto KPIs for changed inputs.</div>}
              </div>
            </div>
          </div>
          <div className="mt-4 flex justify-end gap-3">
            <button onClick={() => setShowConfirmPopup(false)} className="px-4 py-2 border rounded text-sm">Cancel</button>
            <button onClick={confirmSubmit} disabled={submitting} className="px-4 py-2 bg-orange-600 text-white rounded text-sm">
              {submitting ? "Saving..." : "Confirm & Save"}
            </button>
          </div>
        </div>
      </div>
    );
  };

  const renderAdjustPopup = () => {
    if (!showAdjustPopup || !adjustPopupRecord) return null;
    const rec = readingsForm[adjustPopupRecord.id];
    if (!rec) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
        <div className="bg-white rounded-lg w-full max-w-md p-4">
          <h4 className="text-lg font-semibold mb-3">Edit Adjustment — {rec.display_name}</h4>
          <div className="mb-3">
            <div className="text-xs text-gray-500">Today Reading</div>
            <div className="font-mono text-sm text-gray-800">{rec.today === "" ? "—" : rec.today}</div>
          </div>
          <div>
            <label className="text-xs text-gray-500">Adjustment Value</label>
            <input
              type="number"
              step="0.001"
              value={adjustPopupRecord.adjust}
              onChange={(e) => setAdjustPopupRecord((p) => ({ ...p, adjust: e.target.value === "" ? "" : Number(e.target.value) }))}
              className="w-full px-3 py-2 border rounded mt-2 focus:border-orange-500 outline-none"
              autoFocus
            />
          </div>
          <div className="mt-4 flex justify-end space-x-3">
            <button onClick={() => setShowAdjustPopup(false)} className="px-4 py-2 rounded border text-sm">Cancel</button>
            <button onClick={saveAdjust} className="px-4 py-2 rounded bg-orange-600 text-white text-sm">Save</button>
          </div>
        </div>
      </div>
    );
  };

  /* ---------------- lifecycle effects ---------------- */
  useEffect(() => {
    (async () => {
      const items = totalizersByUnit[activeTab] || [];
      await loadTodayReadings(reportDate, activeTab, items);
      await loadYesterdayReadings(reportDate, activeTab, items);
      await loadManualKPIForActiveTab();
      if (activeTab === "Unit-1" || activeTab === "Unit-2") {
        await loadShutdownKPIsForUnitDate(activeTab, reportDate);
      }
    })();
  }, [reportDate, activeTab, totalizersByUnit]);

  useEffect(() => {
    if (!message) return;
    const t = setTimeout(() => setMessage(""), 4000);
    return () => clearTimeout(t);
  }, [message]);

  useEffect(() => {
    setMessage("");
  }, [activeTab, reportDate]);

  const handleDateChange = (days) => {
    const d = new Date(reportDate);
    d.setDate(d.getDate() + days);
    setReportDate(d.toLocaleDateString("en-CA"));
  };

  /* ---------------- Main Render (Sidebar Layout) ---------------- */

  const navItems = [
    { id: "Unit-1", label: "Unit-1", icon: BoltIcon },
    { id: "Unit-2", label: "Unit-2", icon: BoltIcon },
    { id: "Station", label: "Station", icon: CloudIcon },
    { id: "Energy-Meter", label: "Energy Meter", icon: ChartBarIcon },
  ];

  return (
    <div className="flex h-screen overflow-hidden bg-[#F5F5F7] font-sans">
      
      {/* ---------------- LEFT SIDEBAR NAVIGATION ---------------- */}
      <aside className="w-64 flex-shrink-0 flex flex-col bg-white border-r border-gray-200 shadow-[2px_0_10px_rgba(0,0,0,0.03)] z-30">
        
        {/* -- Header: Date & Config -- */}
        <div className="p-4 border-b border-gray-100 bg-gray-50/50">
          <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Configuration</div>
          
          <div className="flex items-center gap-1 mb-1">
             <button onClick={() => handleDateChange(-1)} className="p-1.5 text-gray-500 hover:text-orange-600 hover:bg-white rounded transition-colors">
               <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" /></svg>
             </button>
             <div className="flex-1 relative">
                <input
                    type="date"
                    value={reportDate}
                    onChange={(e) => setReportDate(e.target.value)}
                    className="w-full text-center text-sm font-bold text-gray-800 bg-transparent border-none outline-none focus:ring-0 p-0"
                />
             </div>
             <button onClick={() => handleDateChange(1)} className="p-1.5 text-gray-500 hover:text-orange-600 hover:bg-white rounded transition-colors">
               <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" /></svg>
             </button>
          </div>
          <div className="text-[10px] text-center text-gray-400">{new Date(reportDate).toLocaleDateString('en-US', { weekday: 'long' })}</div>
        </div>

        {/* -- Navigation Items -- */}
        <nav className="flex-1 overflow-y-auto py-4 px-2 space-y-1">
          <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-3 mb-2">Plants</div>
          {navItems.map((item) => {
            const isActive = activeTab === item.id;
            const Icon = item.icon;
            return (
              <button
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={`
                  w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200
                  ${isActive 
                    ? "bg-orange-50 text-orange-700 shadow-sm ring-1 ring-orange-200" 
                    : "text-gray-600 hover:bg-gray-50 hover:text-gray-900"}
                `}
              >
                <Icon className={`w-5 h-5 ${isActive ? "text-orange-500" : "text-gray-400"}`} />
                <span>{item.label}</span>
                {isActive && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-orange-500" />}
              </button>
            );
          })}
        </nav>

        {/* -- Footer Actions -- */}
        <div className="p-4 bg-gray-50 border-t border-gray-200 space-y-3">
            
            {/* Calc & Utility Row */}
            <div className="flex gap-2">
                {(activeTab === "Unit-1" || activeTab === "Unit-2" || activeTab === "Station") && (
                    <button 
                        onClick={() => calculateKPIsForUnit(activeTab)} 
                        disabled={loading}
                        className="flex-1 flex items-center justify-center gap-1 py-2 bg-white border border-gray-200 rounded-md text-xs font-bold text-indigo-600 hover:border-indigo-300 hover:bg-indigo-50 transition-all"
                        title="Calculate KPIs"
                    >
                        {loading ? <Spinner size={12}/> : <ArrowPathIcon className="w-3.5 h-3.5" />}
                        Calc
                    </button>
                )}
                <button 
                    onClick={handleSeedMaster} 
                    disabled={loading}
                    className="flex-1 flex items-center justify-center gap-1 py-2 bg-white border border-gray-200 rounded-md text-xs font-bold text-gray-600 hover:border-gray-300 hover:bg-gray-100 transition-all"
                    title="Seed Previous Day"
                >
                    <BeakerIcon className="w-3.5 h-3.5" /> Seed
                </button>
                <button 
                    onClick={handleResetForm} 
                    className="flex items-center justify-center px-2.5 py-2 bg-white border border-gray-200 rounded-md text-gray-500 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition-all"
                    title="Reset Form"
                >
                   <TrashIcon className="w-3.5 h-3.5" />
                </button>
            </div>

            {/* Primary Submit */}
            <button
                onClick={handleSubmitClick}
                disabled={submitting}
                className="w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-lg shadow-md hover:shadow-lg hover:-translate-y-0.5 active:scale-95 transition-all text-sm font-bold tracking-wide"
            >
                {submitting ? <Spinner size={16}/> : (
                    <>
                        <span>Submit Data</span>
                        <CheckCircleIcon className="w-4 h-4 opacity-80" />
                    </>
                )}
            </button>

            {/* Message Toast (Embedded in Sidebar) */}
            {message && (
                <div className={`mt-2 p-2 rounded text-xs flex items-start gap-2 animate-pulse ${message.startsWith("❌") ? "bg-red-50 text-red-600" : "bg-emerald-50 text-emerald-600"}`}>
                   <span className="flex-1">{message.replace(/^[❌✅⚠️]\s*/, '')}</span>
                </div>
            )}
        </div>
      </aside>

      {/* ---------------- MAIN CONTENT AREA ---------------- */}
      <main className="flex-1 flex overflow-hidden">
        
        {/* CENTER: Data Entry Form */}
        <div className="flex-1 overflow-y-auto p-6 scroll-smooth">
          <div className="max-w-5xl mx-auto">
             <div className="flex items-center justify-between mb-4">
                 <h2 className="text-xl font-bold text-gray-800 tracking-tight">{activeTab} Readings</h2>
                 {lastUpdatedInfo && <span className="text-xs text-gray-400">Last edit by {lastUpdatedInfo.by}</span>}
             </div>

             {/* Totalizer Table */}
             {currentTotalizers.length > 0 ? (
                renderTotalizerTable()
             ) : (
                <div className="p-8 text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">No totalizers configured for this unit.</div>
             )}

             {/* Manual KPIs Section */}
             <div className="mt-8 pt-6 border-t border-gray-200">
                <h3 className="text-sm font-bold text-gray-700 uppercase tracking-wide mb-4 flex items-center gap-2">
                    <span className="w-1 h-4 bg-orange-500 rounded-full"></span>
                    Manual Parameters
                </h3>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  {Object.entries(manualKPI[activeTab] || {}).map(([kname, val]) => (
                    <div key={kname} className="p-3 border border-gray-200 rounded-lg bg-white shadow-sm hover:shadow-md transition-shadow">
                      <div className="text-xs text-gray-500 mb-1.5 font-medium uppercase truncate" title={kname}>
                        {kname.replace(/_/g, " ")}
                      </div>
                      <div className="flex items-center gap-2">
                          <input
                            type="number"
                            step="0.001"
                            value={val ?? ""}
                            onChange={(e) => updateManualField(activeTab, kname, e.target.value)}
                            placeholder="-"
                            className="w-full text-base font-semibold text-gray-800 border-b border-gray-200 focus:border-orange-500 outline-none pb-0.5 bg-transparent"
                          />
                          <span className="text-[10px] text-gray-400 font-medium">{manualUnits[activeTab]?.[kname] || ""}</span>
                      </div>
                    </div>
                  ))}
                </div>
             </div>
          </div>
        </div>

        {/* RIGHT: KPI Panel (Fixed width) */}
        <div className="w-80 bg-white border-l border-gray-200 flex flex-col shadow-[-4px_0_15px_rgba(0,0,0,0.02)] z-10">
            <div className="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                <h3 className="text-sm font-bold text-gray-700 uppercase tracking-wide">Live KPIs</h3>
                <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
            </div>
            <div className="flex-1 overflow-y-auto p-4 bg-gray-50/30">
                {renderLeftKPIList()}
            </div>
        </div>

      </main>

      {/* Popups */}
      {renderConfirmPopup()}
      {renderAdjustPopup()}
    </div>
  );
}